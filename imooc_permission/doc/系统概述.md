# 系统概述

## RBAC模型扩展

有一套独立完整的基于**RBAC**模型的管理功能，管理员角色和后台模块特别多，因此要对RBAC模型进行扩展：在用户上层引入部门，在权限点上层引入权限模块，这样可以以树形结构查看用户和权限点，便于使用

## 获取要拦截的接口

在人工检查每个类不现实的情况下，写1个脚本记录后台系统被访问的url列表，跑几天可以获取到大部分接口，个别没有获取到的也不是核心

## 实现权限拦截

获取到当前用户和访问的url，根据RBAC模型管理的数据，判断是否有权限访问

早期servlet接口是通过不同的参数定义不同的界面

比如上架产品页面请求是/product.do?type=onsale, 下架产品页面请求是/product.do?type=offline，为此单独在权限里支持对参数的检测，检测到配置的权限里包含参数时，逐个参数读取查询匹配，找出最终校验的权限点，间接实现了对**数据权限**的处理

## JSP页面菜单和按钮控制

jsp页面上的**按钮**可以在渲染时判断是否有**权限**，有权限才显示，因此开发了一套做权限校验的标签，用标签将需要判断权限的按钮封装，传入对应的权限唯一标识码，页面加载时无权限的按钮就不会显示

后期做前后端分离时，页面上的按钮是否展示改为先调用接口进行判断，默认不展示，接口返回有权限再进行展示

## 缓存

每次校验都会涉及到多张表的查询操作，这对DB增加特别多的访问，而用户的权限本身变化频率很低，因此权限拦截的许多点要使用**缓存**

## 多级菜单

根据登录用户已分配的权限，生成后台的多级菜单。前提是权限点类型区分了菜单和按钮，同时要求每个模块下面只有一个菜单，保证这个权限模块和权限点的管理就是对实际菜单项及菜单对应页面下的管理，这样根据用户分配的菜单权限，计算出由权限模块和权限点组成的树形结构，然后前端在jsp页面使用JSTL渲染就可以

## 查询

查询指定用户已分配的角色、查询指定用户当前拥有的权限、查询指定权限被哪些角色拥有、查询指定权限被哪些用户拥有等，这些功能很大程度方便权限管理员对权限数据进行维护，另外还支持了动态刷新缓存中的用户权限、在修改了权限配置后让用户权限实时生效、恢复管理员的某次操作，在有人恶意操作或错误操作后能及时回滚权限数据

## 业务扩展

部门里可以增加主管的概念，主管拥有下面员工权限的总和。不光可以对用户分配权限，还可以对部门分配权限，部门下用户都拥有部门分配的权限。部门层级关系有实际含义时，权限可以继承等。这些可以随着业务进行扩展

## 横向越权

横向越权本身和业务联系特别紧密，横向越权最好交给业务层去做，放在权限管理层可以做，但可能会和某些业务排斥，同时如果在权限管理层里做，需要后续的接口遵照规范才可以